#!/bin/bash
set -e

CONFIGURE_SYSTEM=0
while [[ $# -gt 0 ]]; do
  key="$1"
  echo "Key: $key"
  case $key in
    --system)
      CONFIGURE_SYSTEM=1
      ;;
      *)
      ;;
  esac
  shift
done

export current_dir="$(pwd)"

if [ $CONFIGURE_SYSTEM -eq 1 ]; then
  echo "configuring system..."
  ./scripts/configure-system.sh
  cd $current_dir
fi

if [ ! -e ${current_dir}/scripts/heartbeat.sh ] ; then
  print "heartbeat.sh not found"
  exit 1
fi

touch ${current_dir}/alive

set -x
mkdir -p /var/log/waggle/

# copy systemd scripts
cp ${current_dir}/etc/systemd/system/* /etc/systemd/system
systemctl enable waggle-epoch.service
systemctl enable waggle-heartbeat.service
systemctl enable waggle-init.service
systemctl enable waggle-configure-static-iface.service
systemctl enable rabbitmq-server.service
systemctl set-default waggle-platform

# copy udev rules
cp ${current_dir}/etc/udev/rules.d/* /etc/udev/rules.d

# setup .screen
ln -sf ${current_dir}/etc/dot_screen /home/waggle/.screen
ln -sf ${current_dir}/etc/dot_screen /root/.screen

set +x

echo "run: udevadm control --reload-rules"
echo "     udevadm trigger --subsystem-match=tty --action=add"
echo ""
echo "done"

# may want to move into a different script?
cp ${current_dir}/scripts/rabbitmqadmin /usr/bin
